<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NOME DO APP: Onde Ver o Jogo -->
    <title>⚽ Onde Ver o Jogo</title>
    <!-- Carrega o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração do Tailwind para usar a fonte Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'futebol-primaria': '#4F46E5', // Azul índigo vibrante
                        'futebol-secundaria': '#10B981', // Verde esmeralda
                        'futebol-fundo': '#F8FAFC',
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilização básica para o corpo e scrollbar */
        body {
            background-color: #F8FAFC;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        /* Efeito de carregamento (spinner) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4F46E5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o card de resultado */
        .resultado-card {
            border-left: 5px solid #4F46E5;
            transition: all 0.3s ease-in-out;
        }
        .resultado-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Modal de Feedback */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <!-- BOTÃO FLUTUANTE DE FEEDBACK -->
    <button id="feedback-button" class="fixed bottom-4 right-4 bg-futebol-secundaria text-white p-3 rounded-full shadow-xl hover:bg-emerald-600 transition duration-300 ease-in-out z-50">
        <!-- Ícone de balão de fala SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.805A9.73 9.73 0 0112 3c4.97 0 9 3.582 9 8z" />
        </svg>
    </button>
    
    <!-- MODAL DE FEEDBACK (Oculto por padrão) -->
    <div id="feedback-modal" class="modal-overlay hidden">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl">
            <h3 class="text-xl font-bold text-futebol-primaria mb-4">Enviar Feedback</h3>
            <textarea id="feedback-input" rows="4" placeholder="O que você achou do app? Sua opinião é importante!" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-futebol-primaria focus:border-futebol-primaria shadow-sm resize-none"></textarea>
            <div id="feedback-message" class="text-sm mt-2 hidden"></div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="close-modal-button" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                <button id="send-feedback-button" class="px-4 py-2 bg-futebol-secundaria text-white font-semibold rounded-lg hover:bg-emerald-600 transition duration-150 flex items-center disabled:opacity-50">
                    <span id="feedback-button-text">Enviar</span>
                    <div id="feedback-loading-spinner" class="hidden spinner ml-2 !border-t-white !w-4 !h-4"></div>
                </button>
            </div>
        </div>
    </div>


    <div id="app-container" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 mt-4 mb-8">
        
        <!-- Cabeçalho -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-extrabold text-futebol-primaria mb-1">
                ⚽ Onde Ver o Jogo
            </h1>
            <p class="text-gray-500 text-sm font-semibold">Dica: Use "TIME A X TIME B" ou "Próximo jogo do TIME" para melhor precisão.</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-1 hidden"></p>
        </header>

        <!-- Formulário de Pesquisa -->
        <div class="space-y-4">
            <label for="search-input" class="block text-sm font-medium text-gray-700">
                O que você quer assistir?
            </label>
            <input 
                type="text" 
                id="search-input" 
                placeholder="Ex: Flamengo X Corinthians, ou Próximo jogo do Palmeiras" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-futebol-primaria focus:border-futebol-primaria shadow-sm transition duration-150 ease-in-out"
            >
            <button 
                id="search-button" 
                class="w-full bg-futebol-primaria text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <span id="button-text">Buscar Transmissão</span>
                <div id="loading-spinner" class="hidden spinner ml-2 !border-t-white !w-6 !h-6"></div>
            </button>
            
            <!-- BOTÃO DE ANALISE COM GEMINI API -->
            <button 
                id="analysis-button" 
                class="w-full bg-futebol-secundaria text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-emerald-600 transition duration-300 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed mt-2"
            >
                <span id="analysis-button-text">✨ Pré-jogo e Curiosidades ✨</span>
                <div id="analysis-loading-spinner" class="hidden spinner ml-2 !border-t-white !w-6 !h-6"></div>
            </button>
        </div>

        <!-- Área de Resultados -->
        <div id="results-container" class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-2">
                Resultado da Busca (Transmissão)
            </h2>
            
            <div id="result-output" class="resultado-card p-4 bg-white rounded-lg shadow-md text-gray-600 min-h-[100px] flex items-center justify-center text-center">
                Digite um jogo ou time acima e clique em "Buscar Transmissão" para começar.
            </div>

            <!-- Fonte/Citações -->
            <div id="sources-output" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-500 hidden">
                <p class="font-semibold mb-1 text-gray-700">Fontes:</p>
                <ul id="sources-list" class="list-disc ml-5 space-y-1">
                    <!-- Fontes serão inseridas aqui -->
                </ul>
            </div>

            <!-- CONTAINER PARA ANÁLISE PRÉ-JOGO -->
            <h2 class="text-xl font-bold text-gray-800 mb-4 mt-8 border-b border-gray-200 pb-2">
                Análise Pré-jogo (Gerada por IA)
            </h2>
            <div id="analysis-output" class="resultado-card p-4 bg-white rounded-lg shadow-md text-gray-600 min-h-[100px] flex items-center justify-center text-center">
                Use o botão "Pré-jogo e Curiosidades" para gerar uma análise sobre o confronto!
            </div>
        </div>

        <!-- Mensagem de Erro/Alerta -->
        <div id="message-box" class="mt-4 p-4 text-sm rounded-lg text-white hidden"></div>

    </div>

    <script type="module">
        // =============================================================================
        // FIREBASE / API CONFIGURAÇÃO GLOBAL
        // =============================================================================

        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais fornecidas pelo ambiente (Obrigatórias)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Variáveis globais do Firebase e Auth
        let db;
        let auth;
        let userId = null;

        // Variável global para a chave da API Gemini
        const apiKey = "AIzaSyCe9SjGDNwcVVoyDyFAKJ_57mIFACvF62g"; 
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Inicialização e Autenticação do Firebase
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                // Exibe o ID do usuário (Importante para o suporte/monitoramento)
                document.getElementById('user-id-display').textContent = `ID do Usuário: ${userId}`;
                document.getElementById('user-id-display').classList.remove('hidden');
                
            } catch (error) {
                console.error("Erro na inicialização do Firebase ou autenticação:", error);
                showMessage("Erro ao conectar ao serviço de feedback. Tente recarregar a página.", 'error');
            }
        }

        // Chama a inicialização
        initFirebase();

        // =============================================================================
        // UTILITÁRIOS GERAIS
        // =============================================================================

        // Configuração de backoff exponencial para retentar a chamada da API
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Erro HTTP: ${response.status} - ${errorData.error.message}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                }
            }
        }

        // Funções de Mensagem (Toast/Alerta)
        function showMessage(text, type = 'error') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-green-500');
            }
        }

        function hideMessage() {
            document.getElementById('message-box').classList.add('hidden');
        }

        // =============================================================================
        // FUNCIONALIDADES DO APP (Busca de Transmissão e Análise Pré-Jogo)
        // =============================================================================

        // Variáveis do DOM para Busca de Transmissão
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultOutput = document.getElementById('result-output');
        const sourcesOutput = document.getElementById('sources-output');
        const sourcesList = document.getElementById('sources-list');
        
        // Variáveis do DOM para Análise Pré-jogo
        const analysisButton = document.getElementById('analysis-button');
        const analysisButtonText = document.getElementById('analysis-button-text');
        const analysisLoadingSpinner = document.getElementById('analysis-loading-spinner');
        const analysisOutput = document.getElementById('analysis-output');


        // FUNÇÃO DE BUSCA DE TRANSMISSÃO (Usa Gemini com Google Search Grounding)
        async function findBroadcast() {
            const userQuery = searchInput.value.trim();
            if (userQuery.length < 5) {
                showMessage("Por favor, digite o nome de um time ou jogo específico (ex: 'Palmeiras x São Paulo hoje').", 'error');
                return;
            }

            hideMessage();
            searchButton.disabled = true;
            buttonText.textContent = 'Buscando...';
            loadingSpinner.classList.remove('hidden');
            resultOutput.innerHTML = '<div class="text-futebol-primaria font-semibold">Procurando informações atualizadas...</div>';
            sourcesOutput.classList.add('hidden');
            sourcesList.innerHTML = '';

            try {
                // INSTRUÇÃO DO SISTEMA para Busca de Transmissão (foco em Grounding e precisão)
                const systemPrompt = `
                    Você é um localizador especializado em transmissões de jogos de futebol (soccer) no Brasil. 
                    Sua função é encontrar e listar TODOS os canais de TV (aberta ou fechada) e serviços de streaming/digitais oficiais que transmitirão a partida.

                    **PROCESSO DE BUSCA PARA PRÓXIMOS JOGOS (MUITO IMPORTANTE):**
                    Se a consulta usar termos como "próximo jogo", "jogo de amanhã" ou "jogo de terça", a primeira etapa é usar a busca na web para IDENTIFICAR A DATA, HORÁRIO E ADVERSÁRIO EXATOS da partida. Somente após confirmar qual é o jogo, encontre o canal de transmissão. Isso garante a precisão.

                    **Regras de Nomenclatura e Inclusão:**
                    1.  **Canais Digitais:** Inclua explicitamente canais digitais e iniciativas online/YouTube (Ex: YouTube (GETV), YouTube (CazéTV), Twitch, etc.) se forem a fonte oficial.
                    2.  **Streaming:** Use os nomes de marcas de streaming mais atuais e reconhecíveis no Brasil. Se a transmissão for da Disney/ESPN, use **ESPN e Disney+**. Evite o termo "Star+" se "Disney+" for o nome primário associado ao conteúdo ESPN na sua região.
                    3.  **Formato:** O formato da resposta deve ser uma lista concisa e clara separada por vírgulas. Não adicione saudações ou frases introdutórias, apenas a informação da transmissão.
                    4.  **Resposta Padrão:** Se a informação não for encontrada, responda estritamente com 'Não foi possível encontrar a transmissão'.
                `;

                const payload = {
                    contents: [{ parts: [{ text: `Qual é o canal de TV ou streaming que está transmitindo: ${userQuery}` }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const response = await fetchWithRetry(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // 1. Extrai o resultado da transmissão
                    resultOutput.innerHTML = `
                        <p class="text-2xl font-extrabold text-futebol-primaria mb-2">Transmissão:</p>
                        <p class="text-xl font-bold text-gray-800">${text}</p>
                    `;

                    // 2. Extrai as fontes (citações)
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }

                    if (sources.length > 0) {
                        sources.forEach(source => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-futebol-primaria hover:underline">${source.title}</a>`;
                            sourcesList.appendChild(li);
                        });
                        sourcesOutput.classList.remove('hidden');
                    }

                } else {
                    resultOutput.innerHTML = '<div class="text-red-500 font-semibold">Não foi possível encontrar a informação. Tente refinar a pesquisa (ex: adicione a data ou a hora).</div>';
                }

            } catch (error) {
                console.error("Erro na busca de transmissão:", error);
                showMessage(`Ocorreu um erro ao processar a busca. Detalhe: ${error.message}`, 'error');
                resultOutput.innerHTML = '<div class="text-red-500 font-semibold">Erro de conexão ou API. Verifique o console.</div>';
            } finally {
                searchButton.disabled = false;
                buttonText.textContent = 'Buscar Transmissão';
                loadingSpinner.classList.add('hidden');
            }
        }

        // FUNÇÃO para gerar a análise pré-jogo (Usa Gemini sem Grounding)
        async function generatePreGameAnalysis() {
            const userQuery = searchInput.value.trim();
            if (userQuery.length < 5) {
                showMessage("Por favor, digite o nome de um time ou jogo específico para gerar a análise.", 'error');
                return;
            }

            hideMessage();
            analysisButton.disabled = true;
            analysisButtonText.textContent = 'Gerando Análise...';
            analysisLoadingSpinner.classList.remove('hidden');
            analysisOutput.innerHTML = '<div class="text-futebol-secundaria font-semibold">Analisando dados do confronto e gerando o texto...</div>';

            try {
                // INSTRUÇÃO DO SISTEMA para a Análise Pré-jogo
                const systemPromptAnalysis = `
                    Você é um analista de futebol brasileiro apaixonado e conciso. 
                    Sua tarefa é gerar uma pequena análise pré-jogo e curiosidades sobre o confronto fornecido pelo usuário.
                    O texto deve ter cerca de 4 a 6 frases, ser envolvente e abordar a história recente, destaques da partida ou o momento atual dos times.
                    Não inclua saudações ou títulos.
                    Foque apenas no resumo do confronto.
                `;
                
                const promptText = `Gere uma análise pré-jogo e curiosidades sobre o confronto: ${userQuery}`;

                const payload = {
                    contents: [{ parts: [{ text: promptText }] }],
                    systemInstruction: {
                        parts: [{ text: systemPromptAnalysis }]
                    },
                };

                const response = await fetchWithRetry(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const analysisText = candidate.content.parts[0].text;
                    const formattedText = analysisText.split('\n').map(p => `<p class="mb-2 text-left">${p}</p>`).join('');
                    analysisOutput.innerHTML = `<div class="text-gray-800">${formattedText}</div>`;

                } else {
                    analysisOutput.innerHTML = '<div class="text-red-500 font-semibold">Não foi possível gerar a análise pré-jogo.</div>';
                }

            } catch (error) {
                console.error("Erro na geração da análise:", error);
                showMessage(`Ocorreu um erro ao gerar a análise. Detalhe: ${error.message}`, 'error');
                analysisOutput.innerHTML = '<div class="text-red-500 font-semibold">Erro de conexão ou API. Verifique o console.</div>';
            } finally {
                analysisButton.disabled = false;
                analysisButtonText.textContent = '✨ Pré-jogo e Curiosidades ✨';
                analysisLoadingSpinner.classList.add('hidden');
            }
        }


        // =============================================================================
        // FUNCIONALIDADE DE FEEDBACK (FIREBASE FIRESTORE)
        // =============================================================================

        const feedbackButton = document.getElementById('feedback-button');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const sendFeedbackButton = document.getElementById('send-feedback-button');
        const feedbackInput = document.getElementById('feedback-input');
        const feedbackButtonText = document.getElementById('feedback-button-text');
        const feedbackLoadingSpinner = document.getElementById('feedback-loading-spinner');
        const feedbackMessage = document.getElementById('feedback-message');

        function openFeedbackModal() {
            feedbackModal.classList.remove('hidden');
            feedbackInput.value = ''; // Limpa o campo
            feedbackMessage.classList.add('hidden');
        }

        function closeFeedbackModal() {
            feedbackModal.classList.add('hidden');
        }

        function showFeedbackMessage(text, type = 'success') {
            feedbackMessage.textContent = text;
            feedbackMessage.classList.remove('hidden', 'text-red-500', 'text-green-600');
            if (type === 'success') {
                feedbackMessage.classList.add('text-green-600');
            } else {
                feedbackMessage.classList.add('text-red-500');
            }
        }

        async function submitFeedback() {
            const feedbackText = feedbackInput.value.trim();
            if (!feedbackText) {
                showFeedbackMessage("O campo de feedback não pode estar vazio.", 'error');
                return;
            }

            if (!db || !userId) {
                showFeedbackMessage("Serviço de feedback indisponível. Tente recarregar a página.", 'error');
                return;
            }

            sendFeedbackButton.disabled = true;
            feedbackButtonText.textContent = 'Enviando...';
            feedbackLoadingSpinner.classList.remove('hidden');
            feedbackMessage.classList.add('hidden');

            try {
                // Caminho de coleção para dados privados do usuário: /artifacts/{appId}/users/{userId}/feedback
                const feedbackCollectionPath = `artifacts/${appId}/users/${userId}/feedback`;
                const feedbackRef = collection(db, feedbackCollectionPath);

                await addDoc(feedbackRef, {
                    text: feedbackText,
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    appVersion: "1.0.0" // Pode ser útil para rastrear
                });

                showFeedbackMessage("Obrigado! Seu feedback foi enviado com sucesso.", 'success');
                // Fechar modal após um pequeno delay para o usuário ler a mensagem
                setTimeout(closeFeedbackModal, 2000); 

            } catch (error) {
                console.error("Erro ao enviar feedback para o Firestore:", error);
                showFeedbackMessage(`Erro ao enviar feedback: ${error.message}`, 'error');
            } finally {
                sendFeedbackButton.disabled = false;
                feedbackButtonText.textContent = 'Enviar';
                feedbackLoadingSpinner.classList.add('hidden');
            }
        }


        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================

        // Eventos de Busca e Análise
        searchButton.addEventListener('click', findBroadcast);
        analysisButton.addEventListener('click', generatePreGameAnalysis);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                findBroadcast();
            }
        });

        // Eventos do Modal de Feedback
        feedbackButton.addEventListener('click', openFeedbackModal);
        closeModalButton.addEventListener('click', closeFeedbackModal);
        sendFeedbackButton.addEventListener('click', submitFeedback);
        
        // Fechar modal ao clicar fora
        feedbackModal.addEventListener('click', (e) => {
            if (e.target === feedbackModal) {
                closeFeedbackModal();
            }
        });

    </script>
</body>
</html>
